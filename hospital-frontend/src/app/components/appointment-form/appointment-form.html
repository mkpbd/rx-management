<div class="appointment-form-container">
  <mat-toolbar color="primary" class="form-toolbar">
    <mat-icon>event</mat-icon>
    <span class="toolbar-title">
      {{ isEditMode ? 'Edit Appointment' : 'Create New Appointment' }}
    </span>
    <span class="toolbar-spacer"></span>
    <button mat-icon-button (click)="onCancel()" matTooltip="Close">
      <mat-icon>close</mat-icon>
    </button>
  </mat-toolbar>

  <div class="form-content">
    <mat-card class="appointment-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>person_add</mat-icon>
          Appointment Details
        </mat-card-title>
        <mat-card-subtitle>
          {{ isEditMode ? 'Update the appointment information below' : 'Fill in the appointment information below' }}
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="appointmentForm" (ngSubmit)="onSubmit()" class="appointment-form">
          <!-- Patient Selection -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Patient *</mat-label>
              <mat-select formControlName="patientId" required>
                <mat-option *ngFor="let patient of patients" [value]="patient.id">
                  {{ getPatientDisplayName(patient) }}
                  <span class="patient-email">({{ patient.email }})</span>
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>person</mat-icon>
              <mat-error *ngIf="patientId?.hasError('required') && patientId?.touched">
                Patient selection is required
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Doctor Selection -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Doctor *</mat-label>
              <mat-select formControlName="doctorId" required>
                <mat-option *ngFor="let doctor of doctors" [value]="doctor.id">
                  {{ getDoctorDisplayName(doctor) }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>local_hospital</mat-icon>
              <mat-error *ngIf="doctorId?.hasError('required') && doctorId?.touched">
                Doctor selection is required
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Date and Time Row -->
          <div class="form-row dual-column">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Appointment Date *</mat-label>
              <input
                matInput
                [matDatepicker]="appointmentDatePicker"
                formControlName="appointmentDate"
                readonly
                required>
              <mat-datepicker-toggle matSuffix [for]="appointmentDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #appointmentDatePicker></mat-datepicker>
              <mat-error *ngIf="appointmentDate?.hasError('required') && appointmentDate?.touched">
                Appointment date is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Time *</mat-label>

              <input
                matInput
                type="time"
                formControlName="appointmentTime"
                required>
              <mat-icon matSuffix>access_time</mat-icon>
              <mat-error *ngIf="appointmentTime?.hasError('required') && appointmentTime?.touched">
                Appointment time is required
              </mat-error>
            </mat-form-field>

          </div>

          <!-- Status Selection -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Status *</mat-label>
              <mat-select formControlName="status" required>
                <mat-option *ngFor="let status of appointmentStatuses" [value]="status.value">
                  {{ status.label }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>flag</mat-icon>
              <mat-error *ngIf="status?.hasError('required') && status?.touched">
                Status selection is required
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Visit Type Selection -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Visit Type *</mat-label>
              <mat-select formControlName="visit" required>
                <mat-option *ngFor="let visitType of visitypes" [value]="visitType.value">
                  {{ visitType.label }}
                </mat-option>
              </mat-select>
              <mat-icon matSuffix>medical_services</mat-icon>
              <mat-error *ngIf="visit?.hasError('required') && visit?.touched">
                Visit type selection is required
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Notes -->
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Additional Notes</mat-label>
              <textarea
                matInput
                formControlName="notes"
                rows="4"
                placeholder="Any additional information about the appointment"
                maxlength="500">
              </textarea>
              <mat-icon matSuffix>note</mat-icon>
              <mat-hint>{{ notes?.value?.length || 0 }}/500</mat-hint>
              <mat-error *ngIf="notes?.hasError('maxlength')">
                Notes cannot exceed 500 characters
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Loading Indicator -->
          <div *ngIf="isLoading" class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>{{ isEditMode ? 'Updating appointment...' : 'Creating appointment...' }}</p>
          </div>

          <!-- Prescription Details Section -->
          <div class="prescription-section" *ngIf="!isLoading">
            <app-prescription-detail
              [appointmentId]="appointmentId"
              [prescriptionDetails]="prescriptionDetails"
              [appointmentData]="getAppointmentDataForPDF()"
              (prescriptionChanged)="onPrescriptionChanged($event)">
            </app-prescription-detail>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions" *ngIf="!isLoading">
            <button
              mat-button
              type="button"
              (click)="onCancel()"
              class="cancel-button">
              <mat-icon>cancel</mat-icon>
              Cancel
            </button>

            <button
              mat-button
              type="button"
              (click)="onReset()"
              class="reset-button"
              [disabled]="!appointmentForm.dirty">
              <mat-icon>refresh</mat-icon>
              Reset
            </button>

            <button
              mat-raised-button
              color="primary"
              type="submit"
              class="submit-button"
              [disabled]="appointmentForm.invalid">
              <mat-icon>save</mat-icon>
              {{ isEditMode ? 'Update Appointment' : 'Create Appointment' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>
</div>
